name: Sync susfs4ksu branches and update README

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream repository
        run: |
          git remote add upstream https://gitlab.com/simonpunk/susfs4ksu.git || true
          git fetch upstream --prune

      - name: Mirror upstream branches (exclude wild)
        run: |
          set -euo pipefail

          # List upstream branches safely (no HEAD, no phantom refs)
          UPSTREAM_BRANCHES=$(git for-each-ref \
            --format='%(refname:lstrip=3)' \
            refs/remotes/upstream \
            | grep -v '^HEAD$' \
            | grep -v '^wild$')

          # List origin branches safely (no HEAD, no phantom refs)
          ORIGIN_BRANCHES=$(git for-each-ref \
            --format='%(refname:lstrip=3)' \
            refs/remotes/origin \
            | grep -v '^HEAD$' \
            | grep -v '^wild$')

          # Sync or create branches
          for branch in $UPSTREAM_BRANCHES; do
            echo "Syncing $branch"

            if git show-ref --verify --quiet "refs/heads/$branch"; then
              git checkout "$branch"
            else
              git checkout -b "$branch" "upstream/$branch"
            fi

            git reset --hard "upstream/$branch"
            git push origin "$branch" --force
          done

          # Delete branches removed upstream
          for branch in $ORIGIN_BRANCHES; do
            if ! echo "$UPSTREAM_BRANCHES" | grep -qx "$branch"; then
              echo "Deleting stale branch $branch"
              git push origin --delete "$branch"
            fi
          done

      - name: Update README on wild
        run: |
          set -euo pipefail

          # Checkout wild (never synced)
          if git show-ref --verify --quiet refs/heads/wild; then
            git checkout wild
          else
            git checkout -b wild
          fi

          # Create README if missing
          if [ ! -f README.md ]; then
            cat > README.md << 'EOF'
            # susfs4ksu (Fork)
            
            This repository mirrors all upstream branches from **susfs4ksu**,
            except for the `wild` branch.
            
            ## Branches
            
            <!-- BRANCH-LIST-START -->
            <!-- BRANCH-LIST-END -->
            EOF
          fi

          REPORT=""
          for branch in $UPSTREAM_BRANCHES; do
            COMMIT=$(git rev-parse "upstream/$branch")
            SHORT=${COMMIT:0:7}
            MESSAGE=$(git log -1 --pretty=%s "upstream/$branch")
            LINK="https://gitlab.com/simonpunk/susfs4ksu/-/commit/$COMMIT"

            REPORT="$REPORT- \`$branch\`: [$SHORT]($LINK) â€” $MESSAGE\n"
          done

          awk -v report="$REPORT" '
            /<!-- BRANCH-LIST-START -->/ {
              print
              printf "%s", report
              skip=1
              next
            }
            /<!-- BRANCH-LIST-END -->/ { skip=0 }
            !skip { print }
          ' README.md > README.tmp

          mv README.tmp README.md

          git add README.md
          git commit -m "Update branch commit report" || echo "No README changes"
          git push origin wild
